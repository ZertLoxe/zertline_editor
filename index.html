<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="description" content="Unlimit Your Imagination">
    <meta name="viewport" content="width=device-width, initail-scale=1.0">
    <meta name="keywords" content="zertline, zertloxe">
    <meta name="author" content="zertloxe">

    <script type="text/javascript" src="https://www.dropbox.com/static/api/2/dropins.js" id="dropboxjs" data-app-key="nx511xzzvb1zelk"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment-timezone/0.5.36/moment-timezone-with-data-10-year-range.min.js"></script>
    
    <title>ZL News Edit</title>
</head>
<body>
    <main>
        <div>
            <button id="generateTokenLink">Generate Token</button>
            <p id="tokenstat" style="color: red;font-size: x-large;font-weight: bold;">Not ready</p>
            <p>Title</p>
            <input type="text" id="title">
            <p>Content</p>
            <textarea id="content" cols="50" rows="10"></textarea>
            <p>Link</p>
            <input type="text" id="link">
            <div>
                <p>Media</p>
                <button id="addMedia">Add</button>
                <button id="removeMedia">Remove</button>
                <br>
                <p id="showMediaArray"></p>
                <br>
                <input type="text" id="media" size="100">
            </div>
            <div>
                <p>source</p>

                <input type="radio" value="News" name="source" id="source_new">
                <label for="source_new">News</label>

                <input type="radio" value="Discord" name="source" id="source_discord">
                <label for="source_discord">Discord</label>

                <input type="radio" value="Youtube" name="source" id="source_youtube">
                <label for="source_youtube">Youtube</label>

                <input type="radio" value="Reddit" name="source" id="source_reddit">
                <label for="source_reddit">Reddit</label>

                <input type="radio" value="X" name="source" id="source_x">
                <label for="source_x">X</label>
            </div>

            <button type="button" id="load">load</button>
            <button type="button" id="submit">Submit</button>

            <p>Remove News</p>
            <input type="number" id="remove-id">
            <button type="button" id="remove">Remove</button>

            <div id="jsonData"></div>
        </div>
        
        <script>

            let mediaArray = [];
            let googleDriveImageId;

            function extractImageId(googleDriveLink) {
                const regex = /\/d\/([^/]+)\//;
                const match = googleDriveLink.match(regex); 
                return match ? match[1] : null;
        }

            document.getElementById('addMedia').addEventListener('click', () => {
                const googleDriveLink = document.getElementById('media').value;
                googleDriveImageId = extractImageId(googleDriveLink);
                mediaArray.push(googleDriveImageId);
                document.getElementById("media").value = '';
                document.getElementById("showMediaArray").innerHTML = mediaArray;
                console.log(mediaArray);
            });

            document.getElementById('removeMedia').addEventListener('click', () => {
                mediaArray.pop();
                document.getElementById("showMediaArray").innerHTML = mediaArray;
            });

            const clientId = 'hs2pnr348r68qex';
            const redirectUri = 'https://zertloxe.github.io/zertline_editor/index.html';
            let newWindow;
            let accessToken;

            document.getElementById('generateTokenLink').addEventListener('click', () => {
                const authUrl = `https://www.dropbox.com/oauth2/authorize?client_id=${clientId}&response_type=token&redirect_uri=${redirectUri}`;
                newWindow = window.open(authUrl, '_blank');
                if (!newWindow) {
                    alert('Please allow pop-ups to proceed.');
                }
            });

            let callCount = 0;
            const maxCallCount = 10;
            let animationFrameId;

            function captureURL() {
                if (newWindow) {
                    const newWindowURL = newWindow.location.href;
                    console.log('URL of the new window:', newWindowURL);

                    callCount++;

                    if (callCount >= maxCallCount) {
                        const url = new URL(newWindowURL);
                        console.log(url);
                        const hash = url.hash;
                        accessToken = hash.split('=')[1].split('&')[0];
                        console.log(accessToken);

                        newWindow.close();

                        cancelAnimationFrame(animationFrameId);

                        document.getElementById("tokenstat").innerHTML = "All good, now edit!"
                        document.getElementById("tokenstat").style.color = "green";

                    } else {
                        animationFrameId = requestAnimationFrame(captureURL);
                    }
                }
            }

            document.getElementById('generateTokenLink').addEventListener('click', () => {
                animationFrameId = requestAnimationFrame(captureURL);
            });

                const targetTimeZone = Intl.DateTimeFormat().resolvedOptions().timeZone;

                document.getElementById('remove').addEventListener('click', () => {
                    
                    const apiBaseUrl = 'https://content.dropboxapi.com/2/files';

                    const filePath = "/news.json";

                    fetch(`${apiBaseUrl}/download`, {
                    method: 'POST',
                    headers: {
                        Authorization: `Bearer ${accessToken}`,
                        'Dropbox-API-Arg': JSON.stringify({
                        path: filePath,
                        }),
                    },
                    })
                    .then((response) => response.text())
                    .then((data) => {
                        const jsonData = JSON.parse(data);
                        const numId = document.getElementById('remove-id').value;
                        console.log(numId);
                        console.log(jsonData);

                        newjsonData = jsonData.splice(numId, 1);
                        for (let i = 0; i < jsonData.length - parseInt(numId); i++) {

                        jsonData[i + parseInt(numId)].id -= 1;
                        };
                        console.log(newjsonData);

                        fetch(`${apiBaseUrl}/upload`, {
                        method: 'POST',
                        headers: {
                            Authorization: `Bearer ${accessToken}`,
                            'Content-Type': 'application/octet-stream',
                            'Dropbox-API-Arg': JSON.stringify({
                            path: filePath,
                            mode: { '.tag': 'overwrite' },
                            }),
                        },
                        body: JSON.stringify(jsonData),
                        })
                        .then(() => {
                            console.log('Object appended and saved.');
                        })
                        .catch((error) => {
                            console.error('Error saving JSON: ', error);
                        });

                    })
                    .catch((error) => {
                        console.error('Error reading JSON file: ', error);
                    });
                });

                document.getElementById('load').addEventListener('click', () => {
                
                const sharedLink = "https://www.dropbox.com/scl/fi/gco4rzf3v2uqrq9fr9x2r/news.json?rlkey=cnis2k7k60gntdwydkjpcf0r5&dl=0";

                const directLink = sharedLink.replace("www.dropbox.com", "dl.dropboxusercontent.com");
                
                fetch(directLink)
                .then(news => news.json())
                .then((news) => {
                let out = "";
                for (var i = news.length - 1; i >= 0; i--) {
                    out += "<div id='news-container'>" + 
                    "<div id='news-source-icon'>" +
                    "<h1 id='news-source'>" + news[i].source + 
                    "<div style='color: red'>id:" + news[i].id + 
                    "</div><div style='color: green'>" + moment(news[i].time).tz(targetTimeZone).format('(MMM-D-YYYY) (h:mm a)') + "</div></h1>" +
                    "</div>" +
                    "<div id='news-part'>" +
                    "<h2 id='news-title'>" + news[i].title + "</h2>" +
                    "<p id='news-content'>" + news[i].content + "</p>" +
                    "<a id='news-link' href='" + news[i].link + "' target='_blank'>" + news[i].link + "</a>" +
                    "</div>" +
                    "</div>" +
                    "<br>";
                }
                document.getElementById("jsonData").innerHTML =  out;
                });
                });

                document.getElementById('submit').addEventListener('click', () => {

                const title = document.getElementById('title').value;
                const content = document.getElementById('content').value;
                const link = document.getElementById('link').value;
                const source = document.querySelector('input[name="source"]:checked').value;
                const currentTime = moment().format();
                let idNumberAdd = 0;

                let sharedLink = "https://www.dropbox.com/scl/fi/gco4rzf3v2uqrq9fr9x2r/news.json?rlkey=cnis2k7k60gntdwydkjpcf0r5&dl=0";

                const directLink = sharedLink.replace("www.dropbox.com", "dl.dropboxusercontent.com");

                fetch(directLink)
                .then(news => news.json())
                .then((news) => {
                let idNumber = news.length + idNumberAdd;
                    const output = {
                        "id": idNumber,
                        "time":currentTime,
                        "source": source,
                        "title": title,
                        "content": content,
                        "media":mediaArray,
                        "link": link
                        };
                    idNumberAdd += 1;
                    console.log(output);
                    console.log(idNumber);
                    console.log(idNumberAdd);

                    const apiBaseUrl = 'https://content.dropboxapi.com/2/files';

                    const filePath = "/news.json";

                    fetch(`${apiBaseUrl}/download`, {
                    method: 'POST',
                    headers: {
                        Authorization: `Bearer ${accessToken}`,
                        'Dropbox-API-Arg': JSON.stringify({
                        path: filePath,
                        }),
                    },
                    })
                    .then((response) => response.text())
                    .then((data) => {
                        const jsonData = JSON.parse(data);
                        console.log(jsonData);

                        jsonData.push(output);
                        console.log(jsonData);

                        fetch(`${apiBaseUrl}/upload`, {
                        method: 'POST',
                        headers: {
                            Authorization: `Bearer ${accessToken}`,
                            'Content-Type': 'application/octet-stream',
                            'Dropbox-API-Arg': JSON.stringify({
                            path: filePath,
                            mode: { '.tag': 'overwrite' },
                            }),
                        },
                        body: JSON.stringify(jsonData),
                        })
                        .then(() => {
                            console.log('Object appended and saved.');
                        })
                        .catch((error) => {
                            console.error('Error saving JSON: ', error);
                        });

                    })
                    .catch((error) => {
                        console.error('Error reading JSON file: ', error);
                    });
                });
                });
        </script>
    </main>
</body>
</html>